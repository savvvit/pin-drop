<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .popup-bin {
            background: #2196F3; color: white; border: none; padding: 8px 12px;
            border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px;
        }

        /* Настройка самого облачка */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .leaflet-popup-tip {
            background: white;
        }
        
        /* Контент внутри */
        .popup-container {
            text-align: center;
            padding: 5px;
            min-width: 140px;
        }
        
        .popup-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            display: block;
        }
        
        .popup-btn {
            background: #007AFF; /* Цвет Apple Blue */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        
        .popup-btn:active {
            background: #0056b3;
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="dist/leaflet.js"></script>
    <script>
        const urlCallback = 'https://go.glideapps.com/api/container/plugin/webhook-trigger/8ybSWFv5EtpRd7K8EFGq/e4b0341f-2290-4a50-8bd3-8e4e1b6978cc';

        // Получаем параметры из ссылки
        const urlParams = new URLSearchParams(window.location.search);
        const modeParam = urlParams.get('mode') || 'view';
        const modeIsEdit = modeParam === 'edit';
        const userIdParam = urlParams.get('user_id') || 'guest';
        const orderIdParam = urlParams.get('order_id');
        let latParam = urlParams.get('lat');
        let lngParam = urlParams.get('lng');
        let zoomParam = urlParams.get('zoom') || 13;
        

        // Если точки нет, используем Тбилиси
        let startLat, startLng, startZoom;

        if (!latParam || !lngParam) {
//            41.5024347388, 44.8015156327
            startLat = 41.5024; //41.7151;
            startLng = 44.8015; //44.8271;
            startZoom = 13;
        } else {
            startLat = parseFloat(latParam);
            startLng = parseFloat(lngParam);
            startZoom = parseInt(zoomParam);
        }

        var marker;

        // Ждем полной загрузки страницы
        window.onload = function() {
            // Инициализируем карту с выбранными координатами
            var map = L.map('map', { zoomControl: false }).setView([startLat, startLng], startZoom);
    
//            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
//            L.tileLayer('https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
//                attribution: '© OpenStreetMap'
//            }).addTo(map);
//            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
//                attribution: '© Esri & OpenStreetMap contributors'
//            }).addTo(map);
            L.tileLayer('https://core-renderer-tiles.maps.yandex.net/tiles?l=map&v=22.09.28&x={x}&y={y}&z={z}&lang=ru_RU', {
                attribution: '© Yandex',
                // Важно: Яндекс использует другой масштаб, эти параметры обязательны
                subdomains: [],
                tileSize: 256,
                minZoom: 0,
                maxZoom: 18,
                zoomOffset: 0
            }).addTo(map);

            // Если получены конкретные координаты (не дефолтные), 
            // можно сразу поставить туда маркер

            if (latParam && lngParam) {
                marker = L.marker([startLat, startLng]).addTo(map);
            }
            
            // КРИТИЧНО: Форсируем пересчет размеров карты через 500мс
            // Это решает проблему "серого экрана" в мобильных WebView
            setTimeout(function() {
                map.invalidateSize();
            }, 500);
    
            if (modeIsEdit) {
                map.on('click', function(e) {
                    var lat = e.latlng.lat;
                    var lng = e.latlng.lng;
                    var address;
        
                    if (marker) { marker.setLatLng(e.latlng); } 
                    else { marker = L.marker(e.latlng).addTo(map); }
        
    //                // Получаем адрес (Геокодинг) через бесплатный Nominatim
    //                fetch('https://nominatim.openstreetmap.org/reverse?lat='+ lat + '&lon=' + lng +'&accept-language=ru&format=json', {
    //                        headers: { 'User-Agent': 'MyGlideApp/1.0 (savvvit@gmail.com)' }
    //                })
    //                    .then(res => res.json())
    //                    .then(data => {
    //                        var address = data.display_name || "Адрес не найден";
    //                        
    //                        // Контент всплывающего окна
    //                        var popupContent = `
    //                            <b>Координаты:</b><br>${lat.toFixed(5)}, ${lng.toFixed(5)}<br><br>
    //                            <b>Адрес:</b><br>${address}<br>
    //                            <button class="popup-btn" id="sendBtn">Отправить</button>
    //                        `;
                    // Контент всплывающего окна
                    var popupContent = `
                        <div class="popup-container">
                            <span class="popup-title">Машина здесь</span>
                            <button class="popup-btn" id="glideSendBtn">Отправить</button>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent, {
                        closeButton: false, // Убираем крестик для минимализма
                        offset: [0, -5]     // Немного приподнимаем над маркером
                    }).openPopup();
                    
                    // Привязка события (setTimeout, чтобы кнопка успела появиться в DOM)
                    setTimeout(() => {
                        const btn = document.getElementById('glideSendBtn');
                        if (btn) {
                            btn.onclick = () => {
                                btn.innerText = "Отправка...";
                                btn.style.opacity = "0.7";
                                sendToWebhook(lat, lng, address);
                            };
                        }
                    }, 50);
        
        
//                    document.getElementById('sendBtn').onclick = function() {
//                        sendToWebhook(lat, lng, address);
//                    };
                });
            };
        };
    
        function sendToWebhook(lat, lng, addr) {
//            const urlParams = new URLSearchParams(window.location.search);
//            const userId = params.get('user_id') || 'guest';

            // Подготовка данных для Glide
            const payload = {
                latitude: lat,
                longitude: lng,
                address: addr,
                user_id: userIdParam,
                order_id: orderIdParam
            };            
            fetch(urlCallback, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            })
            .then(() => {
                // В режиме no-cors мы всегда попадаем сюда, если нет ошибки сети
//                alert("Данные успешно отправлены!");
                marker.closePopup();
            })
            .catch(err => {
                // Сюда попадем только если ВООБЩЕ нет интернета
                alert("Ошибка сети: " + err);
                console.error(err);
            });
        }
    </script>
</body>
</html>
