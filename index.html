<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .popup-bin {
            background: #2196F3; color: white; border: none; padding: 8px 12px;
            border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="dist/leaflet.js"></script>
    <script>
        const urlCallback = 'https://go.glideapps.com/api/container/plugin/webhook-trigger/8ybSWFv5EtpRd7K8EFGq/e4b0341f-2290-4a50-8bd3-8e4e1b6978cc';

        // Получаем параметры из ссылки
        const urlParams = new URLSearchParams(window.location.search);
        const modeParam = urlParams.get('mode') || 'view';
        const modeIsEdit = modeParam === 'edit';
        const userIdParam = urlParams.get('user_id') || 'guest';
        const orderIdParam = urlParams.get('order_id');
        let latParam = urlParams.get('lat');
        let lngParam = urlParams.get('lng');
        let zoomParam = urlParams.get('zoom') || 13;
        

        // Если точки нет, используем Тбилиси
        let startLat, startLng, startZoom;

        if (!latParam || !lngParam) {
            startLat = 41.7151;
            startLng = 44.8271;
            startZoom = 13;
        } else {
            startLat = parseFloat(latParam);
            startLng = parseFloat(lngParam);
            startZoom = parseInt(zoomParam);
        }

        // Ждем полной загрузки страницы
        window.onload = function() {
            // Инициализируем карту с выбранными координатами
            var map = L.map('map', { zoomControl: false }).setView([startLat, startLng], startZoom);
    
//            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
//            L.tileLayer('https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
//                attribution: '© OpenStreetMap'
//            }).addTo(map);
//            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
//                attribution: '© Esri & OpenStreetMap contributors'
//            }).addTo(map);
            L.tileLayer('https://core-renderer-tiles.maps.yandex.net/tiles?l=map&v=22.09.28&x={x}&y={y}&z={z}&lang=ru_RU', {
                attribution: '© Yandex',
                // Важно: Яндекс использует другой масштаб, эти параметры обязательны
                subdomains: [],
                tileSize: 256,
                minZoom: 0,
                maxZoom: 18,
                zoomOffset: 0
            }).addTo(map);

            // Если получены конкретные координаты (не дефолтные), 
            // можно сразу поставить туда маркер
            var marker;

            if (latParam && lngParam) {
                var marker = L.marker([startLat, startLng]).addTo(map);
            }
            
            // КРИТИЧНО: Форсируем пересчет размеров карты через 500мс
            // Это решает проблему "серого экрана" в мобильных WebView
            setTimeout(function() {
                map.invalidateSize();
            }, 500);
    
            if (modeIsEdit) {
                map.on('click', function(e) {
                    var lat = e.latlng.lat;
                    var lng = e.latlng.lng;
                    var address;
        
                    if (marker) { marker.setLatLng(e.latlng); } 
                    else { marker = L.marker(e.latlng).addTo(map); }
        
    //                // Получаем адрес (Геокодинг) через бесплатный Nominatim
    //                fetch('https://nominatim.openstreetmap.org/reverse?lat='+ lat + '&lon=' + lng +'&accept-language=ru&format=json', {
    //                        headers: { 'User-Agent': 'MyGlideApp/1.0 (savvvit@gmail.com)' }
    //                })
    //                    .then(res => res.json())
    //                    .then(data => {
    //                        var address = data.display_name || "Адрес не найден";
    //                        
    //                        // Контент всплывающего окна
    //                        var popupContent = `
    //                            <b>Координаты:</b><br>${lat.toFixed(5)}, ${lng.toFixed(5)}<br><br>
    //                            <b>Адрес:</b><br>${address}<br>
    //                            <button class="popup-btn" id="sendBtn">Отправить</button>
    //                        `;
                    var popupContent = `
                        <b>Машина здесь</b><br><br><br>
                        <button class="popup-btn" id="sendBtn">Отправить</button>
                    `;
        
                    marker.bindPopup(popupContent).openPopup();
        
                    // Обработка нажатия кнопки "Отправить"
                    document.getElementById('sendBtn').onclick = function() {
                        sendToWebhook(lat, lng, address);
                    };
                });
            };
        };
    
        function sendToWebhook(lat, lng, addr) {
//            const urlParams = new URLSearchParams(window.location.search);
//            const userId = params.get('user_id') || 'guest';

            // Подготовка данных для Glide
            const payload = {
                latitude: lat,
                longitude: lng,
                address: addr,
                user_id: userIdParam,
                order_id: orderIdParam
            };            
            fetch(ulrCallback, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (response.ok) {
                    alert("Данные успешно отправлены!");
                    marker.closePopup();
                } else {
                    alert("Ошибка отправки данных.");
                }
            })
            .catch(err => alert("Ошибка сети: " + err));
        }
    </script>
</body>
</html>
