<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .popup-bin {
            background: #2196F3; color: white; border: none; padding: 8px 12px;
            border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px;
        }

        /* Настройка самого облачка */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .leaflet-popup-tip {
            background: white;
        }
        
        /* Контент внутри */
        .popup-container {
            text-align: center;
            padding: 5px;
            min-width: 140px;
        }
        
        .popup-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            display: block;
        }
        
        .popup-btn {
            background: #007AFF; /* Цвет Apple Blue */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        
        .popup-btn:active {
            background: #0056b3;
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="dist/leaflet.js"></script>
    <script>
        const urlCallback = 'https://go.glideapps.com/api/container/plugin/webhook-trigger/8ybSWFv5EtpRd7K8EFGq/e4b0341f-2290-4a50-8bd3-8e4e1b6978cc';

        // Получаем параметры из ссылки
        const urlParams = new URLSearchParams(window.location.search);
        const modeParam = urlParams.get('mode') || 'view';
        const modeIsEdit = modeParam === 'edit';
        const userIdParam = urlParams.get('user_id') || 'guest';
        const orderIdParam = urlParams.get('order_id');
        let latParam = urlParams.get('lat');
        let lngParam = urlParams.get('lng');
        let zoomParam = urlParams.get('zoom') || 20;

        // Сдвиг карты Yandex для центра Тбилиси 
        const latCorrection = 41.693418 - 41.502435;
        const lngCorrection = 44.801465 - 44.801516;
        

        // Если точки нет, используем центр Тбилиси
        let startLat, startLng, startZoom;

        if (!latParam || !lngParam) {
            startLat = 41.502435;
            startLng = 44.801516;
            startZoom = 13;
        } else {
            startLat = parseFloat(latParam) - latCorrection;
            startLng = parseFloat(lngParam) - lngCorrection;
            startZoom = parseInt(zoomParam);
        }

        let marker;

        // Ждем полной загрузки страницы
        window.onload = function() {
            // Инициализируем карту с выбранными координатами
            var map = L.map('map', { zoomControl: false }).setView([startLat, startLng], startZoom);
    
//            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
//            L.tileLayer('https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
//                attribution: '© OpenStreetMap'
//            }).addTo(map);
//            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
//                attribution: '© Esri & OpenStreetMap contributors'
//            }).addTo(map);
            L.tileLayer('https://core-renderer-tiles.maps.yandex.net/tiles?l=map&v=22.09.28&x={x}&y={y}&z={z}&lang=ru_RU', {
                attribution: '© Yandex',
                // Важно: Яндекс использует другой масштаб, эти параметры обязательны
                subdomains: [],
                tileSize: 256,
                minZoom: 0,
                maxZoom: 18,
                zoomOffset: 0
            }).addTo(map);

            // Если получены конкретные координаты (не дефолтные), 
            // можно сразу поставить туда маркер

            if (latParam && lngParam) {
                marker = L.marker([startLat, startLng]).addTo(map);
            }
            
            // КРИТИЧНО: Форсируем пересчет размеров карты через 500мс
            // Это решает проблему "серого экрана" в мобильных WebView
            setTimeout(function() {
                map.invalidateSize();
            }, 500);
    
            if (modeIsEdit) {
                map.on('click', function(e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;
                    let displayAddress;
                    let structuredAddress;
        
                    if (marker) { marker.setLatLng(e.latlng); } 
                    else { marker = L.marker(e.latlng).addTo(map); }
                    
                    // Контент всплывающего окна
                    const popupContent = `
                        <div class="popup-container">
//                            <span class="popup-title">Машина здесь</span>
                            <div id="address-status" style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                Определяем адрес...
                            </div>
                            <button class="popup-btn" id="glideSendBtn">Машина здесь</button>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent, {
                        closeButton: false, // Убираем крестик для минимализма
                        offset: [0, -5]     // Немного приподнимаем над маркером
                    }).openPopup();
                    
                    // Получаем адрес (Геокодинг) через бесплатный Nominatim
                    fetch('https://nominatim.openstreetmap.org/reverse?lat='+ (lat + latCorrection) + '&lon=' + (lng + lngCorrection) +'&accept-language=ru&format=json&addressdetails=1', {
                            headers: { 'User-Agent': 'MyGlideApp/1.0 (savvvit@gmail.com)' }
                    })
                    .then(res => {
                        if (!res.ok) throw new Error(); // Если сервер ответил ошибкой (например, 400 или 500)
                        return res.json();
                    })
                    .then(data => {
                        const a = data.address;
                        
                        // Формируем "красивый" адрес для показа пользователю (до города)
                        // Выбираем только улицу/дом и район/город
                        const street = a.road || a.pedestrian || "";
                        const house = a.house_number || "";
                        const city = a.city || a.town || a.village || "";
                        const suburb = a.suburb || "";
                        const postcode = a.postcode || "";
                        const full = data.display_name || "";
                        
                        const shortAddress = (`${street} ${house}${street ? ', ' : ''}${city}`.trim()) || "Адрес не найден";

                        // Даем Leaflet 50-100мс на отрисовку окна в DOM
                        setTimeout(() => {
                            // Обновляем текст в уже открытом окне
                            document.getElementById('address-status').innerHTML = 
                                `Примерный адрес:<br><b style="color: #333;">${shortAddress}</b>`;
            
                            // Подготавливаем данные для кнопки (как в прошлом шаге)
                            setupSendButton(lat + latCorrection, lng + lngCorrection, JSON.stringify({ street, house, city, suburb, postcode, full, display: shortAddress }));
                        }, 100);
                    })
                    .catch(() => {
                        // ЕСЛИ ОШИБКА: Меняем текст на уведомление, но оставляем кнопку
                        setTimeout(() => {
                            const statusEl = document.getElementById('address-status');
                            if (statusEl) {
                                statusEl.innerHTML = `<span style="color: #f44336;">Адрес не определен (ошибка сети)</span>`;
                            }
                            // Кнопка все равно будет работать, отправит только координаты
                            setupSendButton(lat + latCorrection, lng + lngCorrection, JSON.stringify({ note: "Ошибка геокодинга" }));
                        }, 100);
                    });                            
                });
            };
        };

        // Вспомогательная функция для активации кнопки
        function setupSendButton(lat, lng, jsonAddr) {
            const btn = document.getElementById('glideSendBtn');
            if (btn) {
                btn.onclick = () => {
                    btn.innerText = "Отправка...";
                    btn.style.opacity = "0.7";
                    sendToWebhook(lat, lng, jsonAddr);
                };
            }
        }
    
        function sendToWebhook(lat, lng, jsonAddr) {
//            const urlParams = new URLSearchParams(window.location.search);
//            const userId = params.get('user_id') || 'guest';

            // Подготовка данных для Callback
            const payload = {
                latitude: lat,
                longitude: lng,
                address: jsonAddr,
                user_id: userIdParam,
                order_id: orderIdParam
            };            
            fetch(urlCallback, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            })
            .then(() => {
                // В режиме no-cors мы всегда попадаем сюда, если нет ошибки сети
//                alert("Данные успешно отправлены!");
                marker.closePopup();
            })
            .catch(err => {
                // Сюда попадем только если ВООБЩЕ нет интернета
                alert("Ошибка сети: " + err);
                console.error(err);
            });
        }
    </script>
</body>
</html>
